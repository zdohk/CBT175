++ USERMOD (NAPT001) .
++ VER (Z038) FMID(HTE21C2).
++JCLIN.
//STEP1    EXEC PGM=IEV90
//SYSPUNCH DD  DSN=&&PUNCH(IKJEFF53),DISP=SHR
//SYSIN  DD  SYS1.USERSRC(IKJEFF53),DISP=SHR
++SRC (IKJEFF53) DISTLIB(USERSRC).
*          DATA SET IKJEFF53CM AT LEVEL 002 AS OF 05/19/88
IKJEFF53 TITLE 'MVS CUSTOM-BUILT IPO SUPPLIED FIB INSTALLATION EXIT    C00001**2
                        '                                               00002**2
*/*                                                                     00003**2
*/* LIB: IPO1.SAMPLIB(IKJEFF53)                                         00004**2
*/* GDE: CBIPO MVS CUSTOMIZATION                                        00005**2
*/* DOC: THIS IS THE ASSEMBLER SOURCE CODE FOR THE                      00006**2
*/*      SAMPLE MVS CUSTOM-BUILT IPO TSO OUTPUT, STATUS AND             00007**2
*/*      CANCEL EXIT ROUTINE.                                           00008**2
*/*                                                                     00009**2
*             MODULE NAME = IKJEFF53                                  * 00010**2
*                                                                     * 00011**2
*             DESCRIPTIVE NAME =  MVS CUSTOM-BUILT IPO                * 00012**2
*                SUPPLIED FIB EXIT FOR TSO                            * 00013**2
*                CANCEL, OUTPUT AND STATUS COMMANDS                   * 00014**2
*                                                                     * 00015**2
*             FUNCTION =                                              * 00016**2
*                VALIDITY CHECKS JOBNAME ON A CANCEL, OUTPUT OR       * 00017**2
*                STATUS FIB (FOREGROUND INITIATED BACKGROUND)         * 00018**2
*                COMMAND.  ALLOWS FOR STATUS WITH JOBNAME 'TSO'       * 00019**2
*                                                                     * 00020**2
*                OPERATION =                                          * 00021**2
*                   STATUS:  IF JOBNAME IS NOT 'TSO' RETURN TO        * 00022**2
*                   CALLER SINCE ANY JOBNAME WILL BE ALLOWED.         * 00023**2
*                   IF JOBNAME IS 'TSO' PUT OUT LIST OF USERIDS       * 00024**2
*                   WITH ADDRESS SPACE ID AND TERMINAL ADDRESS        * 00025**2
*                   OR SYMBOLIC TERMINAL NAME (TSO/VTAM).             * 00026**2
*                   RETURN TO CALLER WITH RETURN CODE OF 12 TO        * 00027**2
*                   SKIP JOBNAME SEARCH FOR 'TSO'.                    * 00028**2
*                                                                     * 00029**2
*                   OUTPUT:  FIRST CHECK IF THE USER HAS OPERATOR     * 00030**2
*                   AUTHORITY.  IF YES, ALLOW THE USER TO OUTPUT      * 00031**2
*                   ANY JOBNAME.  IF THE USER DOES NOT HAVE OPERATOR  * 00032**2
*                   AUTHORITY COMPARE THE USERID WITH THE JOBNAME     * 00033**2
*                   PASSED.  IF THE JOBNAME IS NOT THE USERID OR      * 00034**2
*                   DOES NOT START WITH THE USERID, THE JOBNAME       * 00035**2
*                   IS REJECTED BY FIRST RETURNING TO THE CALLER      * 00036**2
*                   AN ERROR MESSAGE AND A RETURN CODE REQUESTING     * 00037**2
*                   THAT THE MESSAGE BE ISSUED VIA THE PUTLINE        * 00038**2
*                   MECHANISM.  WHEN REENTERED FOR THE JOBNAME,       * 00039**2
*                   THE EXIT ISSUES A RETURN CODE REJECTING THE       * 00040**2
*                   JOBNAME.                                          * 00041**2
*                                                                     * 00042**2
*                   CANCEL:  FIRST CHECK IF THE USER HAS OPERATOR     * 00043**2
*                   AUTHORITY.  IF YES, ALLOW THE USER TO CANCEL      * 00044**2
*                   ANY JOBNAME (THE MVS SYSTEM WILL PREVENT THE      * 00045**2
*                   USER FROM CANCELLING STARTED TASKS AND TSO        * 00046**2
*                   SESSIONS).  IF THE USER DOES NOT HAVE OPERATOR    * 00047**2
*                   AUTHORITY COMPARE THE USERID WITH THE JOBNAME     * 00048**2
*                   PASSED.  IF THE JOBNAME IS NOT THE USERID PLUS    * 00049**2
*                   AT LEAST ONE CHARACTER, THE JOBNAME IS REJECTED   * 00050**2
*                   BY FIRST RETURNING TO THE CALLER AN ERROR         * 00051**2
*                   MESSAGE AND A RETURN CODE REQUESTING THAT THE     * 00052**2
*                   THAT THE MESSAGE BE ISSUED VIA THE PUTLINE        * 00053**2
*                   MECHANISM.  WHEN REENTERED FOR THE JOBNAME,       * 00054**2
*                   THE EXIT ISSUES A RETURN CODE REJECTING THE       * 00055**2
*                   JOBNAME.                                          * 00056**2
*                                                                     * 00057**2
*              NOTES =                                                * 00058**2
*                                                                     * 00059**2
*                 DEPENDENCIES = CHARACTER IS EBCDIC.  REASSEMBLE     * 00060**2
*                    IF A DIFFERENT CHARACTER SET IS NEEDED.          * 00061**2
*                                                                     * 00062**2
*                 RESTRICTIONS = USES SPKA FORM OF MODESET MACRO      * 00063**2
*                    INSTRUCTION SO MUST RUN SUPERVISOR STATE.        * 00064**2
*                                                                     * 00065**2
*                 REGISTER CONVENTIONS = STANDARD CONVENTIONS.        * 00066**2
*                    REGISTERS 0,1     = WORK REGISTERS               * 00067**2
*                    REGISTER  2       = MODESET KEYADDR              * 00068**2
*                    REGISTER  3       = WORK REGISTER                * 00069**2
*                    REGISTERS 4       = ADDRESSABILITY TO EXIT       * 00070**2
*                                              PARAMETER LIST         * 00071**2
*                    REGISTER  5       = RETURN CODE / ASVT MAXUSERS  * 00072**2
*                    REGISTERS 6,7,8,9 = WORK REGISTERS               * 00073**2
*                    REGISTER  10      = ADDRESSABILITY TO REJECT     * 00074**2
*                                              MESSAGE GETMAINED AREA * 00075**2
*                    REGISTER  11      = ADDRESSABILITY TO GETMAINED  * 00076**2
*                                              DATA AREA              * 00077**2
*                    REGISTER  12      = ADDRESSABILITY TO IKJEFF53   * 00078**2
*                                              CSECT                  * 00079**2
*                    REGISTER  13      = SAVE AREA REGISTER           * 00080**2
*                    REGISTERS 14,15   = WORK REGISTERS               * 00081**2
*                                                                     * 00082**2
*                PATCH LABEL = PATCH (UNUSED AND INTIALIZED TO        * 00083**2
*                   'ZAP*'S)                                          * 00084**2
*                                                                     * 00085**2
*             MODULE TYPE = PROCEDURE                                 * 00086**2
*                                                                     * 00087**2
*                PROCESSOR = ASM                                      * 00088**2
*                                                                     * 00089**2
*                MODULE SIZE = 1K                                     * 00090**2
*                                                                     * 00091**2
*                ATTRIBUTES = PROTECT KEY 1, REENTRANT,               * 00092**2
*                   SUPERVISOR STATE                                  * 00093**2
*                                                                     * 00094**2
*             ENTRY POINTS = IKJEFF53 (ONLY ENTRY POINT)              * 00095**2
*                                                                     * 00096**2
*                LINKAGE =                                            * 00097**2
*                   IKJEFF51:  (CANCEL OR STATUS COMMAND) VIA CALL    * 00098**2
*                   IKJCT469:  (OUTPUT COMMAND) VIA CALL              * 00099**2
*                                                                     * 00100**2
*             INPUT = REGISTER 1 POINTS TO PARAMETER LIST MAPPED      * 00101**2
*                BY IKJEFFIE MACRO                                    * 00102**2
*                                                                     * 00103**2
*             OUTPUT = SEE EXIT TOPICAL HEADING BELOW                 * 00104**2
*                                                                     * 00105**2
*             EXIT - NORMAL = AT PROGRAM END VIA BRANCH REGISTER 14   * 00106**2
*                                                                     * 00107**2
*                OUTPUT = NONE                                        * 00108**2
*                                                                     * 00109**2
*                RETURN CODE = ZERO                                   * 00110**2
*                                                                     * 00111**2
*             EXIT - ERROR = AT PROGRAM END VIA BRANCH REGISTER 14    * 00112**2
*                                                                     * 00113**2
*                OUTPUT = MESSAGEP SET IN THE INPUT PARAMETER LIST.   * 00114**2
*                   IF RETURN IS FROM STATUS FOR JOBNAME 'TSO' THEN   * 00115**2
*                   RETURN CODE IS 12 AND NO MESSAGE WILL BE ISSUED.  * 00116**2
*                                                                     * 00117**2
*                RETURN CODE =                                        * 00118**2
*                   4  - ISSUE PROMPT AND RETURN REPLY   (IEPROMPT)   * 00119**2
*                   8  - ISSUE MESSAGE AND RETURN        (IEMSG)      * 00120**2
*                   12 - REJECT THIS JOB                 (IEREJECT)   * 00121**2
*                   16 - TERMINATE THIS COMMAND          (IEABORT)    * 00122**2
*                   (THIS VERSION USES ERROR CODE 8 AND 12)           * 00123**2
*                                                                     * 00124**2
*             EXTERNAL REFERENCES =                                   * 00125**2
*                                                                     * 00126**2
*                ROUTINES = NONE                                      * 00127**2
*                                                                     * 00128**2
*                DATA AREAS = NONE                                    * 00129**2
*                                                                     * 00130**2
*                CONTROL BLOCKS = PARMLIST, CVT, ASVT, ASCB, TSB      * 00131**2
*                                                                     * 00132**2
*             TABLES = DATA AREA TO BE GETMAINED.  MAPPED BY DSECT    * 00133**2
*                BEGINNING AT LABEL DATA.                             * 00134**2
*                                                                     * 00135**2
*             MACROS = IKJEFFIE, FREEMAIN, GETMAIN, SAVE, TPUT, CVT,  * 00136**2
*                      IKJTSB, IKTTSBX                                * 00137**2
*                                                                     * 00138**2
*             CHANGE ACTIVITY =                                         00139**2
*                                                                     * 00140**2
*                COMPARE OF USERID AND JOBNAME LENGTH MOVED        CUJ* 00141**2
*                CHECK FOR INVALID JOBNAME ADDED                   INJ* 00142**2
*                                                                     * 00143**2
*             MESSAGES =                                              * 00144**2
*                                                                     * 00145**2
*                NO MESSAGES ARE ISSUED BY THIS MODULE UNLESS         * 00146**2
*                STATUS IS ISSUED FOR JOBNAME 'TSO'.                  * 00147**2
*                MESSAGE TEXTS ARE, HOWEVER, PASSED BACK TO THE       * 00148**2
*                CALLER IN AN AREA GETMAINED BY THIS EXIT.            * 00149**2
*                FOR CANCEL THE MESSAGE IS THAT FOUND AT LABEL        * 00150**2
*                REJTEXT1.  FOR OUTPUT THE MESSAGE IS THAT FOUND      * 00151**2
*                AT LABEL REJTEXT2.  FOR STATUS WITH JOBAME 'TSO'     * 00152**2
*                TPUT IS USED TO PUT OUT LINES OF OUTPUT WHICH        * 00153**2
*                GIVE USERID, ADDRESS SPACE ID AND TERMINAL           * 00154**2
*                ADDRESS.  A HEADER LINE IS FOUND AT LABEL            * 00155**2
*                HEADER AND A TRAILER LINE IS FOUND AT LABEL          * 00156**2
*                USERS.  IF THIS MODULE ISSUED ITS OWN PUTLINE'S OR   * 00157**2
*                PUTGET'S WITH SECOND LEVELS, IT WOULD NEED TO DO     * 00158**2
*                MODESET TO KEY 0 BEFORE ISSUING THE MESSAGE(S).      * 00159**2
*                THEN DO A MODESET BACK TO KEY 1 BEFORE RETURNING     * 00160**2
*                TO THE CALLER.                                       * 00161**2
*                                                                     * 00162**2
*             ABEND CODES = NONE                                      * 00163**2
*                                                                     * 00164**2
*********************************************************************** 00165**2
         EJECT                                                          00166**2
IKJEFF53 CSECT                                                          00167**2
         SAVE  (14,12),,IKJEFF53.IPO.&SYSTIME..&SYSDATE SAVE REGISTERS  00168**2
*                                      WITH CSECT IDENTIFIER            00169**2
         BALR  R12,0                   BRANCH AND LOAD REGISTER 12      00170**2
PSTART   DS    0H                      LABEL USED WHEN ESTABLISHING     00171**2
         USING PSTART,R12              CSECT ADDRESSABILITY             00172**2
         L     R0,SIZDATD              LOAD REGISTER 0 WITH SIZE FOR    00173**2
*                                      GETMAIN                          00174**2
         GETMAIN R,LV=(0)              ISSUE REGISTER FORM OF GETMAIN   00175**2
*                                      FOR AREA IN SUBPOOL 0            00176**2
         LR    R11,R1                  LOAD REGISTER 11 WITH ADDRESS OF 00177**2
*                                      GETMAINED AREA                   00178**2
         USING DATD,R11                ESTABLISH ADDRESSABILITY TO      00179**2
*                                      GETMAINED AREA                   00180**2
         ST    R13,SAVEAREA+4          SAVE REGISTER 13 FOR SAVEAREA    00181**2
*                                      CHAINING                         00182**2
         LM    R0,R1,20(R13)           RELOAD REGISTERS 0 AND 1 FROM    00183**2
*                                      PREVIOUS SAVEAREA                00184**2
         ST    R11,8(,R13)             SAVE ADDRESS OF CURRENT SAVEAREA 00185**2
         LR    R13,R11                 LOAD REGISTER 13 WITH ADDRESS OF 00186**2
*                                      CURRENT SAVEAREA                 00187**2
         LR    R4,R1                   LOAD REGISTER 4 WITH POINTER TO  00188**2
*                                      PARAMETER LIST                   00189**2
         USING IEPARML,R4              ESTABLISH ADDRESSABILITY TO      00190**2
*                                      PARAMETER LIST (USES             00191**2
*                                      IKJEFFIE MAPPING MACRO)          00192**2
         LA    R5,IECONTIN             INITIALIZE REGISTER 5 FOR RETURN 00193**2
*                                      CODE FOR NORMAL CASE - JOBNAME   00194**2
*                                      IS GOOD AND COMMAND SHOULD       00195**2
*                                      CONTINUE PROCESSING              00196**2
         SPACE 2                                                        00197**2
*********************************************************************** 00198**2
*                                                                     * 00199**2
*        ALWAYS DO PROCESSING                                         * 00200**2
*                                                                     * 00201**2
*********************************************************************** 00202**2
         SPACE 2                                                        00203**2
         L     R6,IECODEP              LOAD COMMAND CODE POINTER        00204**2
         CLI   0(R6),IECANCEL          SEE IF COMMAND IS CANCEL         00205**2
         BE    PROCESS                 YES....CONTINUE PROCESSING       00206**2
         CLI   0(R6),IEOUTPUT          SEE IF COMMAND IS OUTPUT         00207**2
         BE    PROCESS                 YES....CONTINUE PROCESSING       00208**2
         CLI   0(R6),IESTATUS          SEE IF COMMAND IS STATUS         00209**2
         BNE   ENDPROC                 NO.....DO NO PROCESSING          00210**2
*                                      IF INVALID CODE                  00211**2
         SPACE 2                                                        00212**2
*********************************************************************** 00213**2
*                                                                     * 00214**2
*        SEE IF SECOND TIME ENTRY FOR A JOB -                         * 00215**2
*           MESSAGE POINTER NOT ZERO                                  * 00216**2
*                                                                     * 00217**2
*********************************************************************** 00218**2
         SPACE 2                                                        00219**2
PROCESS  DS    0H                                                       00220**2
         L     R6,IEMSGP               LOAD MESSAGE POINTER             00221**2
         LTR   R6,R6                   SEE IF MESSAGE ISSUED FOR LAST   00222**2
*                                      ENTRY                            00223**2
         BNZ   FREEMESS                YES....GO FREE MESSAGE BUFFER    00224**2
         SPACE 2                                                        00225**2
*********************************************************************** 00226**2
*                                                                     * 00227**2
*        DETERMINE IF THIS IS FOR CANCEL                              * 00228**2
*           NO.....GO TO OUTPUT ROUTINE                               * 00229**2
*           YES....IF USER HAS OPERATOR AUTHORITY THEN O.K.           * 00230**2
*              ELSE CHECK IF JOBNAME IS VALID FOR CANCEL              * 00231**2
*              CANCEL NEEDS JOBNAME EQUAL TO USERID                   * 00232**2
*              PLUS AT LEAST ONE CHARACTER                            * 00233**2
*                                                                     * 00234**2
*********************************************************************** 00235**2
         SPACE 2                                                        00236**2
VALIDITY DS    0H                                                       00237**2
         L     R6,IECODEP              LOAD COMMAND POINTER             00238**2
         CLI   0(R6),IECANCEL          SEE IF COMMAND IS CANCEL         00239**2
         BNE   OUTPUT                  NO.....GO SEE IF OUTPUT COMMAND  00240**2
         EXTRACT PSCBADDR,'S',FIELDS=PSB,MF=(E,EXTLIST)                 00241**2
*                                      GET ADDRESS OF PROTECTED STEP    00242**2
*                                      CONTROL BLOCK                    00243**2
         L     R1,PSCBADDR             LOAD POINTER TO PSCB             00244**2
         TM    PSCBATR1(R1),PSCBCTRL   SEE IF USER HAS OPERATOR         00245**2
*                                      AUTHORITY                        00246**2
         BO    ENDPROC                 YES....GO TO END OF PROCEDURE    00247**2
*                                      O.K. TO CANCEL ANY JOBNAME       00248**2
         L     R15,IEIDLENP            LOAD USERID LENGTH POINTER       00249**2
         CLI   0(R15),0                CHECK WHETHER JOBNAME IS VALID   00250**2
         BE    BADJOBN                 JOBNAME IS INVALID IF USERID     00251**2
*                                      IS NOT AVAILABLE (LENGTH=0 FOR   00252**2
*                                      FOR TSO COMMANDS IN BACKGROUND)  00253**2
         SLR   R14,R14                 ZERO REGISTER 14                 00254**2
         IC    R14,0(,R15)             INSERT USERID LENGTH INTO        00255**2
*                                      REGISTER 14 AND LOAD             00256**2
         L     R6,IENAMELP             LOAD JOBNAME LENGTH POINTER  CUJ 00257**2
         CH    R14,0(,R6)              SEE IF USERID LENGTH IS      CUJ 00258**2
*                                      SHORTER THAN JOBNAME LENGTH  CUJ 00259**2
         BNL   BADJOBN                 NO.....GO BUILD INVALID      CUJ 00260**2
*                                      JOBNAME MESSAGE              CUJ 00261**2
         L     R6,IEUSRIDP             LOAD USERID POINTER          CUJ 00262**2
         L     R1,IEJOBNMP             LOAD JOBNAME POINTER         CUJ 00263**2
         BCTR  R14,0                   DECREMENT R14 FOR            CUJ 00264**2
         EX    R14,JOBNCOMP            EXECUTE OF COMPARE           CUJ 00265**2
         BNE   BADJOBN                 NO.....GO BUILD INVALID JOBNAME  00266**2
*                                      MESSAGE                          00267**2
         B     ENDPROC                 GO ACCEPT JOBNAME                00268**2
         SPACE 2                                                        00269**2
*********************************************************************** 00270**2
*                                                                     * 00271**2
*        SEE IF THIS IS OUTPUT COMMAND                                * 00272**2
*           NO.....GO TO STATUS ROUTINE                               * 00273**2
*           YES....IF USER HAS OPERATOR AUTHORITY THEN O.K.           * 00274**2
*              ELSE CHECK IF JOBNAME IS VALID FOR OUTPUT              * 00275**2
*              OUTPUT NEEDS JOBNAME EQUAL TO USERID OR                * 00276**2
*              EQUAL TO USERID PLUS AT LEAST ONE CHARACTER            * 00277**2
*                                                                     * 00278**2
*********************************************************************** 00279**2
         SPACE 2                                                        00280**2
OUTPUT   DS    0H                                                       00281**2
         CLI   0(R6),IEOUTPUT          SEE IF COMMAND IS OUTPUT         00282**2
         BNE   STATUS                  NO.....GO SEE IF STATUS COMMAND  00283**2
         EXTRACT PSCBADDR,'S',FIELDS=PSB,MF=(E,EXTLIST)                 00284**2
*                                      GET ADDRESS OF PROTECTED STEP    00285**2
*                                      CONTROL BLOCK                    00286**2
         L     R1,PSCBADDR             LOAD POINTER TO PSCB             00287**2
         TM    PSCBATR1(R1),PSCBCTRL   SEE IF USER HAS OPERATOR         00288**2
*                                      AUTHORITY                        00289**2
         BO    ENDPROC                 YES....GO TO END OF PROCEDURE    00290**2
*                                      O.K. TO OUTPUT ANY JOBNAME       00291**2
         L     R15,IEIDLENP            LOAD USERID LENGTH POINTER       00292**2
         CLI   0(R15),0                CHECK WHETHER JOBNAME IS VALID   00293**2
         BE    BADJOBN                 JOBNAME IS INVALID IF USERID     00294**2
*                                      IS NOT AVAILABLE (LENGTH=0 FOR   00295**2
*                                      FOR TSO COMMANDS IN BACKGROUND)  00296**2
         SLR   R14,R14                 ZERO REGISTER 14                 00297**2
         IC    R14,0(,R15)             INSERT USERID LENGTH INTO        00298**2
*                                      REGISTER 14                      00299**2
         L     R6,IENAMELP             LOAD JOBNAME LENGTH POINTER  CUJ 00300**2
         CH    R14,0(,R6)              SEE IF USERID LENGTH         CUJ 00301**2
*                                      IS EQUAL TO OR SHORTER       CUJ 00302**2
*                                      THAN JOBNAME LENGTH          CUJ 00303**2
         BH    BADJOBN                 NO.....GO BUILD INVALID      CUJ 00304**2
*                                      JOBNAME MESSAGE              CUJ 00305**2
         L     R6,IEUSRIDP             LOAD USERID POINTER          CUJ 00306**2
         L     R1,IEJOBNMP             LOAD JOBNAME POINTER         CUJ 00307**2
         BCTR  R14,0                   DECREMENT R14 FOR                00308**2
         EX    R14,JOBNCOMP            EXECUTE OF COMPARE               00309**2
         BE    ENDPROC                 EQUAL..RETURN TO CALLER          00310**2
         SPACE 2                                                        00311**2
*********************************************************************** 00312**2
*                                                                     * 00313**2
*        REJECT THIS INVALID JOBNAME AND BUILD INVALID JOBNAME        * 00314**2
*           MESSAGE                                                   * 00315**2
*                                                                     * 00316**2
*********************************************************************** 00317**2
         SPACE 2                                                        00318**2
BADJOBN  DS    0H                      BUILD BAD JOBNAME MESSAGE        00319**2
         L     R0,GETMINFO             SUBPOOL 0, LENGTH DECIMAL 84     00320**2
         GETMAIN R,LV=(0)              GET MESSAGE BUFFER               00321**2
         ST    R1,IEMSGP               STORE POINTER TO MESSAGE BUFFER  00322**2
*                                      INTO PARAMETER LIST              00323**2
         LR    R10,R1                  LOAD REGISTER 10 WITH ADDRESS OF 00324**2
*                                      GETMAINED AREA                   00325**2
         USING REJMSG,R10              ESTABLISH REGISTER 10 AS BASE    00326**2
*                                      FOR REJECT MESSAGE DSECT         00327**2
         MVI   REJMSG,BLANK            INITIALIZE BUFFER WITH BLANKS    00328**2
         MVC   REJMSG+1(83),REJMSG                                      00329**2
         MVC   REJMLEN(2),HALF84       PUT IN MAXIMUM MESSAGE LENGTH    00330**2
         MVC   REJJOB(4),JOBWORD       PUT IN WORD 'JOB'                00331**2
         L     R1,IENAMELP             LOAD JOBNAME LENGTH POINTER      00332**2
         LH    R15,0(,R1)              LOAD JOBNAME LENGTH              00333**2
         LR    R14,R15                 LOAD REGISTER 14 WITH LENGTH     00334**2
         BCTR  R14,0                   DECREMENT REGISTER 14 FOR MOVE   00335**2
         L     R1,IEJOBNMP             LOAD JOBNAME POINTER             00336**2
         EX    R14,MOVEJOBN            INSERT THE BAD JOBNAME           00337**2
         AH    R15,HALF2               INDEX PAST BLANK AFTER JOBNAME   00338**2
         LR    R5,R15                  LOAD REGISTER 5 AS TEMPORARY     00339**2
*                                      SAVE AREA FOR REGISTER 15        00340**2
         SPACE 2                                                        00341**2
*********************************************************************** 00342**2
*                                                                     * 00343**2
*        DIFFERENT MESSAGE TEXTS FOR CANCEL AND OUTPUT                * 00344**2
*                                                                     * 00345**2
*********************************************************************** 00346**2
         SPACE 2                                                        00347**2
         L     R1,IECODEP              LOAD COMMAND POINTER             00348**2
         CLI   0(R1),IECANCEL          SEE IF COMMAND IS CANCEL         00349**2
         BNE   OUTPMESS                NO.....GO TO OUTPUT MESSAGE      00350**2
         ALR   R10,R5                  OFFSET MESSAGE IN BUFFER         00351**2
         MVC   REJSLOT-1(66),REJTEXT1  MOVE IN TEXT FOR CANCEL          00352**2
         B     SETRC                   GO SET RETURN CODE               00353**2
OUTPMESS DS    0H                                                       00354**2
         ALR   R10,R5                  OFFSET MESSAGE IN BUFFER         00355**2
         MVC   REJSLOT-1(69),REJTEXT2  MOVE IN TEXT FOR OUTPUT          00356**2
SETRC    DS    0H                                                       00357**2
         LA    R5,IEMSG                SET RETURN CODE TO PROMPT        00358**2
         B     ENDPROC                 GO TO RETURN                     00359**2
         SPACE 2                                                        00360**2
*********************************************************************** 00361**2
*                                                                     * 00362**2
*        SEE IF THIS IS STATUS COMMAND                                * 00363**2
*           NO.....GO TO END OF PROCEDURE                             * 00364**2
*           YES....CHECK IF NAME IS 'TSO'                             * 00365**2
*              NO.....GO TO END OF PROCEDURE                          * 00366**2
*              YES....PUT OUT USERIDS, ASIDS, AND ADDRESSES           * 00367**2
*                                                                     * 00368**2
*********************************************************************** 00369**2
         SPACE 2                                                        00370**2
STATUS   DS    0H                                                       00371**2
         CLI   0(R6),IESTATUS          SEE IF COMMAND IS STATUS         00372**2
         BNE   ENDPROC                 NO.....GO TO END OF PROCEDURE    00373**2
         L     R1,IEJOBNMP             LOAD POINTER TO JOBNAME          00374**2
         CLC   TSOWORD,0(R1)           SEE IF JOBNAME IS 'TSO'          00375**2
         BNE   ENDPROC                 NO.....GO TO END OF PROCEDURE    00376**2
         L     R1,IENAMELP             LOAD POINTER TO JOBNAME LENGTH   00377**2
         CLC   HALF3,0(R1)             SEE IF JOBNAME LENGTH IS 3       00378**2
         BNE   ENDPROC                 NO.....GO TO END OF PROCEDURE    00379**2
         L     R15,CVTPTR              LOAD POINTER TO CVT              00380**2
         USING CVTMAP,R15              ESTABLISH ADDRESSABILITY TO CVT  00381**2
         L     R6,CVTASVT              LOAD POINTER TO ASVT             00382**2
         DROP  R15                     DROP ADDRESSABILITY TO CVT       00383**2
         L     R5,ASVTMAXU(R6)         LOAD MAXIMUM NUMBER OF ADDRESS   00384**2
*                                      SPACES                           00385**2
         LA    R6,ASVTENTY-4(R6)       LOAD ADDRESS OF FIRST ASVT ENTRY 00386**2
*                                      MINUS 4                          00387**2
         LA    R3,0                    ZERO OUT USER COUNTER            00388**2
         TPUT  HEADER,L'HEADER         PUT OUT HEADER LINE              00389**2
         SPACE 2                                                        00390**2
*********************************************************************** 00391**2
*                                                                     * 00392**2
*        GO DOWN THE ADDRESS SPACE VECTOR TABLE                       * 00393**2
*           SEE IF ADDRESS SPACE CONTROL BLOCK IS FOR A TSO USER      * 00394**2
*              YES....GET ADDRESS SPACE ID, USERID, AND PHYSICAL      * 00395**2
*                     TERMINAL ADDRESS AND OUTPUT LINE                * 00396**2
*              NO.....GO CHECK NEXT ASCB                              * 00397**2
*                                                                     * 00398**2
*********************************************************************** 00399**2
         SPACE 2                                                        00400**2
ASCBNEXT DS    0H                                                       00401**2
         LTR   R5,R5                   SEE IF MAXUSER COUNTER ZERO      00402**2
         BZ    LASTASCB                YES....GO HANDLE LAST ASCB       00403**2
         BCTR  R5,0                    DECREMENT MAXUSER COUNTER        00404**2
         MVI   LINE,C' '               BLANK OUT THE OUTPUT LINE        00405**2
         MVC   LINE+1(L'LINE-1),LINE                                    00406**2
         LA    R6,4(R6)                LOAD ADDRESS OF NEXT ASVT ENTRY  00407**2
         L     R7,0(R6)                LOAD ADDRESS OF ACSB             00408**2
         USING ASCB,R7                 ESTABLISH ADDRESSABILITY TO ASCB 00409**2
         TM    0(R6),X'80'             SEE IF ASID IS AVAILABLE         00410**2
         BO    ASCBNEXT                YES....GO ON TO NEXT ASVT ENTRY  00411**2
         CLC   ASCBASCB(4),ASCBWORD    ENSURE CONTROL BLOCK IS VALID    00412**2
         BNE   ASCBNEXT                NO.....GO ON TO NEXT ASVT ENTRY  00413**2
         L     R8,ASCBTSB              LOAD ADDRESS OF TSB              00414**2
         USING TSB,R8                  ESTABLISH ADDRESSABILITY TO TSB  00415**2
         LTR   R8,R8                   SEE IF ADDRESS ZERO - NOT TSO    00416**2
         BZ    ASCBNEXT                ZERO...GO ON TO NEXT ASVT ENTRY  00417**2
         MODESET EXTKEY=ZERO,SAVEKEY=(2)  MODESET AND SAVE OLD KEY      00418**2
         TM    TSBFLG5,TSBVTAM         SEE IF THIS IS A TSO/VTAM TSB    00419**2
         BO    GETTSBX                 YES....GO GET TSB EXTENSION      00420**2
         LH    R8,TSBLINE              GET BINARY LINE ADDRESS          00421**2
         STH   R8,PACK                 STORE ADDRESS IN WORKAREA        00422**2
         UNPK  PACK+3(5),PACK(3)       UNPACK THE ADDRESS               00423**2
         MVC   LINEADDR,PACK+4         MOVE UNPACKED ADDRESS INTO LINE  00424**2
         TR    LINEADDR,TRT-240        TRANSLATE TO EBCDIC              00425**2
         B     MODEREST                GO MODESET AND RESTORE OLD KEY   00426**2
GETTSBX  DS    0H                                                       00427**2
         L     R9,TSBEXTNT             GET ADDRESS OF TSB EXTENSION     00428**2
         USING TSBX,R9                 ESTABLISH ADDRESSABILITY TO TSBX 00429**2
         TM    TSBXFLG1,TSBXWREC       SEE IF TERMINAL AWAITING RECON   00430**2
         BNO   GETSYM                  NO.....GO GET SYMBOLIC NAME      00431**2
         MVC   LINESYM(8),DISCON       MOVE IN DISCON'D                 00432**2
         B     MODEREST                GO MODESET AND RESTORE OLD KEY   00433**2
GETSYM   DS    0H                                                       00434**2
         MVC   LINESYM(8),TSBTRMID     MOVE IN TERMINAL SYMBOLIC NAME   00435**2
         DROP  R8,R9                                                    00436**2
MODEREST DS    0H                                                       00437**2
         MODESET KEYADDR=(2)           MODESET AND RESTORE OLD KEY      00438**2
         L     R8,ASCBJBNS             LOAD POINTER TO JOBNAME FIELD    00439**2
         LTR   R8,R8                   SEE IF POINTER IS ZERO           00440**2
         BZ    STARTING                YES....GO MOVE IN 'STARTING'     00441**2
         MVC   LINEUSID,0(R8)          MOVE USERID TO PRINT LINE        00442**2
         B     EDITASID                GO EDIT ASID TO EBCDIC           00443**2
STARTING DS    0H                                                       00444**2
         MVC   LINEUSID,STRTWORD       MOVE 'STARTING' TO PRINT LINE    00445**2
EDITASID DS    0H                                                       00446**2
         LH    R8,ASCBASID             LOAD ADDRESS SPACE ID            00447**2
         CVD   R8,PACK                 CONVERT TO DECIMAL               00448**2
         MVC   CHAR,EDMSK              MOVE EDIT MASK TO CHAR           00449**2
         ED    CHAR,PACK+4             EDIT TO ASID TO EBCDIC           00450**2
         MVC   LINEASID,CHAR+5         MOVE THREE CHARS TO PRINT LINE   00451**2
         LA    R1,LINE                 LOAD POINTER TO LINE             00452**2
         TPUT  (R1),L'LINE             PUT OUT OUTPUT LINE              00453**2
         LA    R3,1(R3)                ADD 1 TO USER COUNT              00454**2
         B     ASCBNEXT                GO ON TO NEXT ASVT ENTRY         00455**2
         DROP  R7                                                       00456**2
         SPACE 2                                                        00457**2
*********************************************************************** 00458**2
*                                                                     * 00459**2
*        AT END OF ASVT CHAIN SO PUT OUT TSO USER COUNT               * 00460**2
*           AND SET RETURN CODE FOR USERID REJECT                     * 00461**2
*           TO AVOID SEARCH FOR JOBNAME 'TSO'                         * 00462**2
*                                                                     * 00463**2
*********************************************************************** 00464**2
         SPACE 2                                                        00465**2
LASTASCB DS    0H                                                       00466**2
         CVD   R3,PACK                 CONVERT USER COUNT TO DECIMAL    00467**2
         MVC   CHAR,EDMSK              MOVE EDIT MASK TO CHAR           00468**2
         ED    CHAR,PACK+4             CONVERT DECIAML COUNT TO EBCDIC  00469**2
         MVC   LINE(4),CHAR+4          MOVE IN COUNT                    00470**2
         MVC   LINE+4(L'USERS),USERS   MOVE IN MESSAGE                  00471**2
         LA    R1,LINE                 LOAD POINTER TO OUTPUT LINE      00472**2
         TPUT  (R1),L'LINE             PUT OUT COUNT MESSAGE            00473**2
         LA    R5,IEREJECT             TREAT AS IF JOBNAME REJECTED     00474**2
         B     ENDPROC                 GO TO END OF PROCEDURE           00475**2
         SPACE 2                                                        00476**2
*********************************************************************** 00477**2
*                                                                     * 00478**2
*        SECOND TIME ENTRY (FREE MESSAGE BUFFER)                      * 00479**2
*                                                                     * 00480**2
*********************************************************************** 00481**2
         SPACE 2                                                        00482**2
FREEMESS DS    0H                                                       00483**2
         L     R1,IEMSGP               LOAD POINTER TO GETMAINED AREA   00484**2
         L     R0,GETMINFO             LOAD SUBPOOL NUMBER AND LENGTH   00485**2
*                                      OF GETMAINED AREA                00486**2
         FREEMAIN  R,LV=(0),A=(1)      FREE MESSAGE BUFFER              00487**2
         SLR   R6,R6                   ZERO OUT MESSAGE POINTER ENTRY   00488**2
         ST    R6,IEMSGP               IN PARMLIST                      00489**2
         LA    R5,IEREJECT             SET RETURN CODE TO 12 - DELETE   00490**2
*                                      ENTRY                            00491**2
         SPACE 2                                                        00492**2
*********************************************************************** 00493**2
*                                                                     * 00494**2
*        RETURN TO CALLER (STATUS, CANCEL, OR OUTPUT COMMAND)         * 00495**2
*                                                                     * 00496**2
*********************************************************************** 00497**2
         SPACE 2                                                        00498**2
ENDPROC  DS    0H                                                       00499**2
         L     R13,4(,R13)             RESTORE REGISTER 13              00500**2
         L     R0,SIZDATD              LOAD REGISTER 0 WITH SIZE OF     00501**2
*                                      GETMAINED AREA                   00502**2
         LR    R1,R11                  LOAD REGISTER 1 WITH ADDRESS OF  00503**2
*                                      GETMAINED AREA                   00504**2
         FREEMAIN R,LV=(0),A=(1)       FREE GETMAINED AREA              00505**2
         LR    R15,R5                  LOAD REGISTER 15 WITH RETURN     00506**2
*                                      CODE                             00507**2
         L     R14,12(,R13)            LOAD REGISTER 14 WITH RETURN     00508**2
*                                      ADDRESS                          00509**2
         LM    R0,R12,20(R13)          RESTORE REGISTERS                00510**2
         BR    R14                     RETURN VIA REGISTER 14           00511**2
         EJECT                                                          00512**2
******** CONSTANTS AND DSECTS *********                                 00513**2
DATA     DS    0H                                                       00514**2
JOBNCOMP CLC   0(0,R6),0(R1)                                            00515**2
MOVEJOBN MVC   REJSLOT(0),0(R1)                                         00516**2
HALF84   DC    H'84'                                                    00517**2
HALF2    DC    H'2'                                                     00518**2
HALF3    DC    H'3'                                                     00519**2
JOBWORD  DC    CL4'JOB '                                                00520**2
BLANK    EQU   C' '                                                     00521**2
DATD     DSECT                                                          00522**2
         DS    0F                                                       00523**2
SAVEAREA DS    18F                                                      00524**2
EXTLIST  EXTRACT MF=L                                                   00525**2
PSCBADDR DS    F                                                        00526**2
PSCBATR1 EQU   16                                                       00527**2
PSCBCTRL EQU   X'80'                                                    00528**2
PACK     DS    D                                                        00529**2
CHAR     DS    CL8                                                      00530**2
LINE     DS    CL26                                                     00531**2
         ORG   LINE+1                                                   00532**2
LINEUSID DS    CL8                                                      00533**2
         ORG   LINE+11                                                  00534**2
LINEASID DS    CL3                                                      00535**2
         ORG   LINE+17                                                  00536**2
LINEADDR DS    CL3                                                      00537**2
         ORG   LINE+17                                                  00538**2
LINESYM  DS    CL8                                                      00539**2
         ORG                                                            00540**2
         DS    0D                                                       00541**2
ENDDATD  EQU   *                                                        00542**2
IKJEFF53 CSECT                                                          00543**2
         DS    0F                                                       00544**2
SIZDATD  DC    AL1(0)                                                   00545**2
         DC    AL3(ENDDATD-DATD)                                        00546**2
REJTEXT1 DC    CL66'REJECTED - JOBNAME MUST BE YOUR USERID PLUS AT LEASC00547**2
               T ONE CHARACTER'                                         00548**2
REJTEXT2 DC    CL69'REJECTED - JOBNAME MUST BE YOUR USERID OR MUST STARC00549**2
               T WITH YOUR USERID'                                      00550**2
HEADER   DC    CL21'  USERID  ASID  LINE '                              00551**2
EDMSK    DC    XL8'4020202020202120'                                    00552**2
USERS    DC    CL20' USERS ARE LOGGED ON'                               00553**2
TRT      DC    CL16'0123456789ABCDEF'                                   00554**2
TSOWORD  DC    CL3'TSO'                                                 00555**2
ASCBWORD DC    CL4'ASCB'                                                00556**2
STRTWORD DC    CL8'STARTING'                                            00557**2
DISCON   DC    CL8'DISCON''D'                                           00558**2
GETMINFO DS    0F                      SUBPOOL AND LENGTH FOR GETMAIN   00559**2
*                                      OF MESSAGE AREA                  00560**2
GETMSP   DC    AL1(0)                                                   00561**2
GETMLEN  DC    AL3(84)                                                  00562**2
PATCH    DC    8CL4'ZAP*'                                               00563**2
R0       EQU   00                      EQUATES FOR REGISTERS 0-15       00564**2
R1       EQU   01                                                       00565**2
R2       EQU   02                                                       00566**2
R3       EQU   03                                                       00567**2
R4       EQU   04                                                       00568**2
R5       EQU   05                                                       00569**2
R6       EQU   06                                                       00570**2
R7       EQU   07                                                       00571**2
R8       EQU   08                                                       00572**2
R9       EQU   09                                                       00573**2
R10      EQU   10                                                       00574**2
R11      EQU   11                                                       00575**2
R12      EQU   12                                                       00576**2
R13      EQU   13                                                       00577**2
R14      EQU   14                                                       00578**2
R15      EQU   15                                                       00579**2
ASVTENTY EQU   528                                                      00580**2
ASVTMAXU EQU   516                                                      00581**2
REJMSG   DSECT                         DSECT FOR RETURN MESSAGE         00582**2
REJMLEN  DS    H                                                        00583**2
REJJOB   DS    CL4                                                      00584**2
REJSLOT  DS    CL9                                                      00585**2
         IKJEFFIE IETYPE=OUTPUT                                         00586**2
         IKJTSB   LIST=YES,EXT=NO                                       00587**2
         IKTTSBX                                                        00588**2
         IHAASCB DSECT=YES                                              00589**2
         CVT DSECT=YES                                                  00590**2
         END   IKJEFF53                                                 00591**2
